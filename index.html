<html>
<html>

<head>
  <title>Socket.IO chart</title>

  <link rel="stylesheet" href="/css/billboard/billboard.min.css" type="text/css">
  <link href="/css/bootstrap/bootstrap.css" rel="stylesheet" type="text/css">

</head>

<body>
  <div id="chart"></div>
  <table id="contact" class="table">
    <thead>
      <tr>
        <th>IP</th>
        <th>OS Name</th>
        <th>Uptime</th>
        <th>CPU Speed GHZ</th>
        <th>Memory Total</th>
        <th>Memory Free</th>
        <th>Memory Used</th>
        <th>CPU Current Load</th>
        <th>Last Contact</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <script src="/js/d3/d3.min.js"></script>
  <!-- Step 2) Load billboard.js with style -->
  <script src="/js/billboard/billboard.min.js" type="text/javascript"></script>


  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/jquery/jquery.min.js"></script>
  <script>
    var count = 0;
    $(function () {
      var socket = io();

      var chart = bb.generate({
        tooltip: {
          show: false
        },

        data: {
          x: "time",
          xFormat: '%Y-%m-%d %H:%M:%S',
          columns: [

          ]
        },
        line: {
          connectNull: true
        },
        axis: {
          x: {
            type: "timeseries",
            tick: {
              fit: true,
              format: '%H:%M:%S' // how the date is displayed
            }
          }
        },
        bindto: "#chart"
      });
      socket.on('aws-event', function (value) {
        if (document.getElementById(value.ip) != null) {
          $(document.getElementById(value.ip)).find(".time").html(value.time);
        } else {
          $("#contact.table tbody").append(
            "<tr id='" + value.ip + "'>"
            + "<td>" + value.ip + "</td>"
            + "<td>" + value.osName + "</td>"
            + "<td>" + value.uptime + "</td>"
            + "<td>" + value.cpuSpeedGHZ + "</td>"
            + "<td>" + value.memTotal + "</td>"
            + "<td>" + value.memFree + "</td>"
            + "<td>" + value.memUsed + "</td>"
            + "<td>" + value.cpuCurrentLoad + "</td>"
            + "<td class='time'>" + value.time + "</td></tr>");
        }
        var dataLengths = chart
          .data()
          .map((col) => col.values.map((item) => item.value))
          .map((values) => values.length);
        var maxListLength = 0;
        for (var i = 0; i < dataLengths.length; i++) {
          if (maxListLength < dataLengths[i]) {
            maxListLength = dataLengths[i];
          }
        }

        var tickLength = maxListLength >= 10 ? 1 : 0;

        chart.flow({
          columns: [
            ["time", value.time],
            [value.ip, value.cpuCurrentLoad]
          ],
          length: tickLength,
          done: function () { chart.flush(); }
        });
      });

    });
  </script>
</body>

</html>